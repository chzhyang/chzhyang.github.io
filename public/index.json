
[{"content":"","date":"2024-05-23","externalUrl":null,"permalink":"/tags/attention/","section":"Tags","summary":"","title":"Attention","type":"tags"},{"content":"","date":"2024-05-23","externalUrl":null,"permalink":"/series/attention/","section":"Series","summary":"","title":"Attention","type":"series"},{"content":"","date":"2024-05-23","externalUrl":null,"permalink":"/posts/","section":"Blogs","summary":"","title":"Blogs","type":"posts"},{"content":"[WIP]\nFlashAttention V2:\nåœ¨V1çš„åŸºç¡€ä¸Šå‡å°‘äº†éçŸ©é˜µä¹˜æ³•è¿ç®—çš„FLOPsã€‚ é€šè¿‡å¹¶è¡ŒåŒ–å’Œä»»åŠ¡åˆ†é…ä¼˜åŒ–æé«˜äº†è®¡ç®—é€Ÿåº¦å’ŒGPUåˆ©ç”¨ç‡ï¼Œæ€§èƒ½æå‡äº†2-3å€ã€‚ Flash-Decodingå€Ÿé‰´äº†FlashAttentionçš„ä¼˜ç‚¹ï¼Œå°†å¹¶è¡ŒåŒ–ç»´åº¦æ‰©å±•åˆ°keys/valuesåºåˆ—é•¿åº¦ï¼Œæé«˜äº†æ¨ç†é€Ÿåº¦ã€‚ Flash-Decodingå‡ ä¹ä¸ç”¨é¢å¤–å­˜å‚¨å¤§é‡æ•°æ®åˆ°å…¨å±€å†…å­˜ä¸­ï¼Œå‡å°‘äº†å†…å­˜å¼€é”€ã€‚ Flash-Decoding++é€šè¿‡å¼‚æ­¥softmaxå’Œç»Ÿä¸€æœ€å¤§å€¼ã€flat GEMMä¼˜åŒ–å’ŒåŒç¼“å†²ã€å¯å‘å¼æ•°æ®æµå’Œç¡¬ä»¶èµ„æºé€‚åº”ç­‰æ–¹æ³•è¿›ä¸€æ­¥æé«˜äº†LLMæ¨ç†çš„æ€§èƒ½ã€‚ ","date":"2024-05-23","externalUrl":null,"permalink":"/posts/llm/flash_attention_2/","section":"Blogs","summary":"[WIP] FlashAttention V2: åœ¨V1çš„åŸºç¡€ä¸Šå‡å°‘äº†éçŸ©é˜µä¹˜æ³•è¿ç®—","title":"Flash Attention V2","type":"posts"},{"content":"","date":"2024-05-23","externalUrl":null,"permalink":"/tags/llm/","section":"Tags","summary":"","title":"LLM","type":"tags"},{"content":"","date":"2024-05-23","externalUrl":null,"permalink":"/posts/llm/","section":"Blogs","summary":"","title":"LLM","type":"posts"},{"content":"","date":"2024-05-23","externalUrl":null,"permalink":"/tags/nlp/","section":"Tags","summary":"","title":"NLP","type":"tags"},{"content":"","date":"2024-05-23","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"},{"content":"","date":"2024-05-23","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"Hi, welcome to my blog.\n","date":"2024-05-23","externalUrl":null,"permalink":"/","section":"Welcome to Blowfish! ğŸ‰","summary":"Hi, welcome to my blog.","title":"Welcome to Blowfish! ğŸ‰","type":"page"},{"content":"FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness\nä¸æ ‡å‡† attention ç›¸æ¯”ï¼ŒFlash Attention æœ‰ä»¥ä¸‹ä¸‰ç‚¹ç‰¹ç‚¹ï¼š\nè¿ç®—é€Ÿåº¦æ›´å¿« (Fast) æ›´èŠ‚çœæ˜¾å­˜ (Memory-Efficient) è®¡ç®—ç»“æœç›¸åŒ (Exact) FlashAttention ç›®çš„ä¸æ˜¯èŠ‚çº¦ FLOPsï¼Œè€Œæ˜¯å‡å°‘å¯¹HBMçš„è®¿é—®ã€‚å®ƒæ²¡æœ‰æ”¹å˜åŸæœ‰çš„è®¡ç®—å…¬å¼ï¼Œæ•´ä½“è®¡ç®—å¤æ‚åº¦å¹¶æœªé™ä½ã€‚\nèƒŒæ™¯ # GPUä¸­å­˜å‚¨å•å…ƒä¸»è¦æœ‰ HBM å’Œ SRAMï¼šHBM å®¹é‡å¤§ä½†æ˜¯è®¿é—®é€Ÿåº¦æ…¢ï¼ŒSRAMå®¹é‡å°å´æœ‰ç€è¾ƒé«˜çš„è®¿é—®é€Ÿåº¦ã€‚ä¾‹å¦‚ï¼šA100 GPUæœ‰40-80GBçš„HBMï¼Œå¸¦å®½ä¸º1.5-2.0TB/sï¼›æ¯108ä¸ªæµå¼å¤šæ ¸å¤„ç†å™¨å„æœ‰192KBçš„ç‰‡ä¸ŠSRAMï¼Œå¸¦å®½ä¼°è®¡çº¦ä¸º 19TB/sã€‚å¯ä»¥çœ‹å‡ºï¼Œç‰‡ä¸Šçš„SRAMæ¯”HBMå¿«ä¸€ä¸ªæ•°é‡çº§ï¼Œä½†å°ºå¯¸è¦å°è®¸å¤šæ•°é‡çº§ã€‚\nå½“è¾“å…¥åºåˆ—ï¼ˆsequence lengthï¼‰è¾ƒé•¿æ—¶ï¼ŒTransformerçš„è®¡ç®—è¿‡ç¨‹ç¼“æ…¢ä¸”è€—è´¹å†…å­˜ï¼Œè¿™æ˜¯å› ä¸º self-attention çš„ time å’Œ memory complexity ä¼šéšç€ sequence length çš„å¢åŠ æˆäºŒæ¬¡å¢é•¿ã€‚\næ ‡å‡†Attentionçš„è®¡ç®—è¿‡ç¨‹ï¼š $$ S=Q K^T \\in \\mathbb{R}^{N \\times N} $$ $$ P=\\operatorname{softmax}(S) \\in \\mathbb{R}^{N \\times N} $$ $$ O=P V \\in \\mathbb{R}^{N \\times N} $$\næ ‡å‡†Attentionçš„ä¸­é—´ç»“æœ ğ‘†, ğ‘ƒ é€šå¸¸éœ€è¦é€šè¿‡é«˜å¸¦å®½å†…å­˜ï¼ˆHBMï¼‰è¿›è¡Œå­˜å–ï¼Œä¸¤è€…æ‰€éœ€å†…å­˜ç©ºé—´å¤æ‚åº¦ä¸º\\(O(Nd+N^2)), å¯¹ HBM çš„é‡å¤è¯»å†™æ˜¯ä¸»è¦ç“¶é¢ˆã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦åšä¸¤ä»¶äº‹ï¼š\nåœ¨ä¸è®¿é—®æ•´ä¸ªè¾“å…¥çš„æƒ…å†µä¸‹è®¡ç®— softmax ä¸ä¸ºåå‘ä¼ æ’­å­˜å‚¨å¤§çš„ä¸­é—´ attention çŸ©é˜µ(\\(N^2\\)) FlashAttention V1 # FlashAttention æå‡ºäº†ä¸¤ç§æ–¹æ³•æ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼štiling å’Œ recomputationã€‚\ntiling - æ³¨æ„åŠ›è®¡ç®—è¢«é‡æ–°æ„é€ ï¼Œå°†è¾“å…¥åˆ†å‰²æˆå—ï¼Œå¹¶é€šè¿‡åœ¨è¾“å…¥å—ä¸Šè¿›è¡Œå¤šæ¬¡ä¼ é€’æ¥é€’å¢åœ°æ‰§è¡Œsoftmaxæ“ä½œã€‚ recomputation - å­˜å‚¨æ¥è‡ªå‰å‘çš„ softmax å½’ä¸€åŒ–å› å­ï¼Œä»¥ä¾¿åœ¨åå‘ä¸­å¿«é€Ÿé‡æ–°è®¡ç®—èŠ¯ç‰‡ä¸Šçš„ attentionï¼Œè¿™æ¯”ä»HBMè¯»å–ä¸­é—´çŸ©é˜µçš„æ ‡å‡†æ³¨æ„åŠ›æ–¹æ³•æ›´å¿«ã€‚å¯ä»¥æŠŠå®ƒçœ‹ä½œåŸºäº tiling çš„ç‰¹æ®Šçš„ gradient checkpointing æ­£å¸¸çš„softmaxè®¡ç®—ï¼š\n$$m(x):=\\max _i x i$$ $$f(x):=\\left[e^{x_1-m(x)} \\ldots e^{x_B-m(x)}\\right]$$ $$\\ell(x):=\\sum_i f(x)_i$$ $$\\operatorname{softmax}(x):=\\frac{f(x)}{\\ell(x)}$$\nsoftmax ä¼ªä»£ç : softmax å‡½æ•°éœ€è¦ä¸‰ä¸ªå¾ªç¯ï¼Œç¬¬ä¸€ä¸ªå¾ªç¯è®¡ç®—æ•°ç»„çš„æœ€å¤§å€¼ï¼Œç¬¬äºŒä¸ªå¾ªç¯è®¡ç®— softmax çš„åˆ†æ¯ï¼Œç¬¬ä¸‰ä¸ªå¾ªç¯è®¡ç®— softmax è¾“å‡ºã€‚\nåˆ†å—çš„ softmax è®¡ç®—(å‡è®¾åˆ†2å—å¹¶è¡Œè®¡ç®—)ï¼š\n$$m(x)=m\\left(\\left[x^{(1)} x^{(2)}\\right]\\right)=\\max \\left(m\\left(x^{(1)}\\right), m\\left(x^{(2)}\\right)\\right) $$ $$f(x)=\\left[e^{m\\left(x^{(1)}\\right)-m(x)} f\\left(x^{(1)}\\right) \\quad e^{m\\left(x^{(2)}\\right)-m(x)} f\\left(x^{(2)}\\right)\\right] $$ $$\\ell(x)=\\ell\\left(\\left[x^{(1)} x^{(2)}\\right]\\right)=e^{m\\left(x^{(1)}\\right)-m(x)} \\ell\\left(x^{(1)}\\right)+e^{m\\left(x^{(2)}\\right)-m(x)} \\ell\\left(x^{(2)}\\right) $$ $$\\operatorname{softmax}(x)=\\frac{f(x)}{\\ell(x)}$$\nåˆ†å—çš„ softmax ä¼ªä»£ç : åœ¨ç¬¬ä¸€ä¸ªå¾ªç¯ä¸­åŒæ—¶å¯¹æœ€å¤§å€¼\\(m\\)ä»¥åŠ softmax çš„åˆ†æ¯\\(d\\)è¿›è¡Œæ›´æ–°ï¼Œä»è€Œå‡å°‘äº†ä¸€ä¸ªå¾ªç¯ã€‚é€šè¿‡ tiling çš„æ–¹å¼ï¼Œsoftmax çš„å¾ªç¯æ•°ä»ä¸‰ä¸ªå‡åˆ°äº†ä¸¤ä¸ªï¼Œä»è€Œå¯ä»¥é™ä½å†…å­˜æ¶ˆè€—ã€‚\nflashattention ä¼ªä»£ç ï¼š ä¸­é—´å˜é‡ï¼š\\(O_i\\)(æœ€ç»ˆä¹˜ç§¯)ã€\\(l_i\\)ï¼ˆsoftmaxçš„åˆ†æ¯ï¼Œå³ç´¯åŠ å’Œï¼‰ã€\\(m_i\\)ï¼ˆéå†åˆ°å½“å‰å—ä¸ºæ­¢çš„æœ€å¤§å€¼ï¼‰ï¼Œå†ä¹Ÿä¸ç”¨ä¿å­˜å…¨éƒ¨çš„Så’ŒPäº†ã€‚\nç”±äºé‡æ–°è®¡ç®—å¯¼è‡´FLOPså¢åŠ ï¼Œä½†æ˜¯ç”±äºå¤§é‡å‡å°‘HBMè®¿é—®ï¼ŒFlashAttentionè¿è¡Œé€Ÿåº¦æ›´å¿«\nFlashAttentionçš„ FLOPs ä¸º\\(ğ‘‚(ğ‘^2ğ‘‘)\\)ï¼Œé™¤äº†inputå’Œoutputï¼Œé¢å¤–éœ€è¦çš„å†…å­˜ä¸º\\(ğ‘‚(ğ‘)\\), å¯¹HBMè®¿é—®çš„æ¬¡æ•°ä¸º\\(ğ‘‚(ğ‘^2ğ‘‘^2ğ‘€^{âˆ’1})\\), æ¯”æ ‡å‡† Attention çš„\\(O(Nd+N^2))æ›´é«˜æ•ˆ\nPyTorch 2.0å·²å°† FlashAttention é›†æˆåˆ°å®˜æ–¹åº“ä¸­ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ torch.nn.functional.scaled_dot_product_attention\næ€»ç»“ # FlashAttention V1:\né€šè¿‡åˆ‡å—æŠ€æœ¯å‡å°‘äº†å†…å­˜è®¿é—®æ¬¡æ•°ï¼Œæé«˜äº†è®¡ç®—é€Ÿåº¦å’Œå†…å­˜åˆ©ç”¨ç‡ã€‚ å†…å­˜è®¿é—®å¤æ‚åº¦ä¸º\\(ğ‘‚(ğ‘^2ğ‘‘^2ğ‘€^{âˆ’1})\\), æ¯”æ ‡å‡† Attention çš„\\(O(Nd+N^2))æ›´é«˜æ•ˆ ","date":"2024-05-23","externalUrl":null,"permalink":"/posts/llm/flash_attention/","section":"Blogs","summary":"FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness ä¸æ ‡å‡† attention ç›¸æ¯”ï¼ŒFlash","title":"Flash Attention","type":"posts"},{"content":"class Me: def __init__(self): self.names = \u0026#34;Victor Yang\u0026#34; self.prefer_name = \u0026#34;Victor\u0026#34; self.profession = \u0026#34;Programmer\u0026#34; self.hometown = \u0026#34;Shandong, CN\u0026#34; self.current_location = \u0026#34;Beijing, CN\u0026#34; self.grad_school = \u0026#34;USTC\u0026#34; self.undergrad_school = \u0026#34;UPC\u0026#34; self.interests = [\u0026#34;ML\u0026#34;, \u0026#34;Robot\u0026#34;] self.hoppies = [\u0026#34;Reading\u0026#34;, \u0026#34;Yoga\u0026#34;, \u0026#34;Meditation\u0026#34;, \u0026#34;Taoist\u0026#34;, \u0026#34;Swimming\u0026#34;] ","date":"2024-05-19","externalUrl":null,"permalink":"/about/","section":"Welcome to Blowfish! ğŸ‰","summary":"class Me: def __init__(self): self.names = \u0026#34;Victor Yang\u0026#34; self.prefer_name = \u0026#34;Victor\u0026#34; self.profession = \u0026#34;Programmer\u0026#34; self.hometown = \u0026#34;Shandong, CN\u0026#34; self.current_location = \u0026#34;Beijing, CN\u0026#34; self.","title":"About","type":"page"},{"content":"This is the advanced tag. Just like other listing pages in Blowfish, you can add custom content to individual taxonomy terms and it will be displayed at the top of the term listing. ğŸš€\nYou can also use these content pages to define Hugo metadata like titles and descriptions that will be used for SEO and other purposes.\n","date":"0001-01-01","externalUrl":null,"permalink":"/tags/advanced/","section":"Tags","summary":"This is the advanced tag. Just like other listing pages in Blowfish, you can add custom content to individual taxonomy terms and it will be displayed at the top of the term listing.","title":"Advanced","type":"tags"},{"content":"","date":"0001-01-01","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","date":"0001-01-01","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","date":"0001-01-01","externalUrl":null,"permalink":"/tags/_index.zh-cn/","section":"Tags","summary":"","title":"æ ‡ç­¾","type":"tags"},{"content":"Hell\n","date":"0001-01-01","externalUrl":null,"permalink":"/_index.zh-cn/","section":"Welcome to Blowfish! ğŸ‰","summary":"Hell","title":"æ¬¢è¿æ¥åˆ° Blowfish! ğŸ‰","type":"page"},{"content":"è¿™æ˜¯é«˜çº§æ ‡è®°ã€‚ç±»ä¼¼å…¶ä»– Blowfish ä¸­çš„å…¶ä»–åˆ—è¡¨é¡µé¢ï¼Œä½ å¯ä»¥åœ¨åˆ†ç±»åˆ—è¡¨é¡µæ·»åŠ è‡ªå®šä¹‰å†…å®¹ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¼šæ˜¾ç¤ºåœ¨é¡¶éƒ¨ã€‚ğŸš€\nä½ ä¹Ÿå¯ä»¥ç”¨è¿™äº›å†…å®¹æ¥å®šä¹‰ Hugo çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚æ ‡é¢˜å’Œæè¿°ã€‚è¿™äº›å†…å®¹å¯ä»¥è¢«ç”¨æ¥å¢å¼º SEO æˆ–å…¶ä»–ç›®çš„ã€‚\n","date":"0001-01-01","externalUrl":null,"permalink":"/tags/advanced/_index.zh-cn/","section":"Tags","summary":"è¿™æ˜¯é«˜çº§æ ‡è®°ã€‚ç±»ä¼¼å…¶ä»– Blowfish ä¸­çš„å…¶ä»–åˆ—è¡¨é¡µé¢","title":"é«˜çº§","type":"tags"}]